/*project:html5mp3play
author:jqy
2016-11-14
*/
define("visualizer",["jquery","exports","module"],function(a,b,c){function d(){window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext,window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame;try{q||(q=new AudioContext)}catch(a){console.log("!妳的浏览器不支持AudioContext:("),console.log(a)}}function e(a,b,c){var d=new XMLHttpRequest,e="getSongsrc.php?base="+encodeURI(a);d.open("GET",e,!0),d.responseType="arraybuffer",d.onload=function(){s=d.response,f(s,b,c)},d.send()}function f(a,b,c){q.decodeAudioData(a,function(a){q.currentTime=0,g(q,a,b,c)},function(a){console.log("!哎玛，文件解码失败:("),"function"==typeof b&&b(!1)})}function g(a,b,c,d){t=a.createBufferSource(),u=a.createAnalyser(),t.connect(u),t.buffer=b,"function"==typeof c&&c(!0,d)}function h(a){var b=document.getElementById("viscanvas"),c=b.width,d=b.height-2,e=3,f=2,g="#fff",h=100,i=[],j=b.getContext("2d"),k=j.createLinearGradient(0,0,0,300);k.addColorStop(1,"#00082F"),k.addColorStop(.5,"#ff0"),k.addColorStop(0,"#f00");var l=function(){var b=new Uint8Array(a.frequencyBinCount);a.getByteFrequencyData(b);var m=Math.round(b.length/h);j.clearRect(0,0,c,d);for(var n=0;n<h;n++){var o=b[n*m];i.length<Math.round(h)&&i.push(o),j.fillStyle=g,o<i[n]?j.fillRect(5*n,d- --i[n],e,f):(j.fillRect(5*n,d-o,e,f),i[n]=o),j.fillStyle=k,j.fillRect(5*n,d-o+f,e,d)}r||requestAnimationFrame(l)};requestAnimationFrame(l)}function i(a){function b(){r||(drawVisual=requestAnimationFrame(b)),f.clearRect(0,0,d,e),a.getByteTimeDomainData(h),f.fillStyle="rgb(200, 200, 200)",f.lineWidth=1,f.strokeStyle="rgb(225, 225, 225)",f.beginPath();for(var i=1*d/g,j=0,k=0;k<g;k++){var l=h[k]/128,m=l*e/2;0===k?f.moveTo(j,m):f.lineTo(j,m),j+=i}f.lineTo(c.width,c.height/2),f.stroke()}var c=document.getElementById("viscanvas"),d=c.width,e=c.height,f=c.getContext("2d");a.fftSize=2048;var g=a.frequencyBinCount,h=new Uint8Array(g);a.getByteTimeDomainData(h),b()}function j(a,b){t&&(t.stop||(t.stop=t.noteOff),t.playing&&t.stop(),r=!0,b||f(s,a))}function k(a){l(a)}function l(a){return t?(t.start(0,a.currentTime),t.playing=!0,a.play(),void o(v_id)):void alert("还未解码完。。")}function m(a,b,c){p(),d(),e(a,b,c),c&&n()}function n(){window.addEventListener("resize",function(){p()},!1),a("#visualizerBar").on("click","li",function(){var b=a(this).attr("id");a(this).addClass("active").siblings("li").removeClass("active"),o(b)})}function o(a){switch(a){case"bolt":r=!0,window.setTimeout(function(){r=!1,i(u)},200),v_id="bolt";break;case"signal":r=!0,window.setTimeout(function(){r=!1,h(u)},200),v_id="signal"}}function p(){var b=a("#visBox"),c=window.innerWidth,d=window.innerHeight;b.css({left:(c-b.width())/2+"px",top:(d-b.height()-100)/2+"px"})}var q=null,r=!1,s=null,t=null,u=null;v_id="bolt",c.exports={init:m,suspend:j,resume:k}}),define("lrcmanager",["exports","module","jquery"],function(a,b,c){function d(a){localStorage[a.fileName]&&""!==localStorage[a.fileName]?f(localStorage[a.fileName]):e(a,function(b){o=b,localStorage[a.fileName]=o,f(o)})}function e(a,b){var d=a.fileName,e=1e3*a.timeLength;c.get("kproxy.php",{base:"/app/i/krc.php",query:encodeURIComponent("cmd=100&keyword="+d+"&timelength="+e+"&q="+(new Date).getTime())},b,"text")}function f(a){n=g(a);var b=n.arrLyric.length,c=[];if(c.push("<ul>"),0===b)c.push("<li>....暂无歌词....</li>");else for(var d=0;d<b;d++){var e=q-d*q;c.push("<li data-top='"+e+"'>"+n.arrLyric[d]+"</li>")}c.push("</ul>"),p.html(c.join("")),r&&clearInterval(r),r=setInterval(function(){i(s.currentTime)},100)}function g(a){for(var b={arrLyric:[],arrLyricTime:[]},c=new RegExp("[[0-9:.]*]","g"),d=a.split("\r\n"),e=0,f=0,g=0;g<d.length;g++){var i=d[g].replace(/\[[\w\W]*\]/g,"").trim();if(""!==i)for(b.arrLyric[g-f]=i;null!==(lrc_result=c.exec(d[g]));){var j=h(lrc_result.toString().replace(/\[|\]/g,""));isNaN(j)||(b.arrLyricTime[e++]=g-f+"|"+j)}else f++}return b}function h(a){try{var b=a.split(":");return 60*parseInt(b[0])+parseFloat(b[1])}catch(a){return 0}}function i(a){for(var b=n.arrLyricTime,c=0;c<b.length;c++){var d=b[c].split("|");if(0===c&&a<d[1])break;if(void 0===b[c+1]){j(d[0]);break}var e=b[c+1].split("|");if(a>=d[1]&&a<e[1]){j(d[0]);break}}}function j(a){if(t!=a){t=a;var b=p.find("li").eq(a),c=b.data("top");b.prev("li").removeClass("cli"),p.find("ul").animate({marginTop:c+"px"},100,function(){b.addClass("cli")})}}function k(a,b){s=b,d(a)}function l(){r&&clearInterval(r)}function m(){r&&clearInterval(r),r=setInterval(function(){i(s.currentTime)},100)}var n=[],o="",p=c(".lrcBox"),q=25,r=null,s=null,t=0;b.exports={init:k,stop:l,resume:m}}),define("player",["require","visualizer","lrcmanager","jquery.mCustomScrollbar","jquery","exports","module"],function(a,b,c,d,e,f,g){function h(a,b,c){var d=b>c?c:b,e=b>c?b-c:0;a.find(".right div").css("transform","rotateZ("+(360/(2*c)*d-180)+"deg)"),a.find(".left div").css("transform","rotateZ("+(360/(2*c)*e-180)+"deg)")}function i(a){q(1),y[0]=a,o()}function j(){n(),o()}function k(a){function b(b){return b.hash!=a.hash}if(localStorage.mylove&&""!==localStorage.mylove){var c=JSON.parse(localStorage.mylove);if(!c.every(b))return;c.push(a),localStorage.mylove=JSON.stringify(c),l()}else localStorage.mylove=JSON.stringify([a])}function l(){if(localStorage.mylove&&""!==localStorage.mylove){var a=JSON.parse(localStorage.mylove),b=[];a.forEach(function(a){b.push("<li data-hash='"+a.hash+"'><span>"+a.filename+"</span><i class='icon-minus'></i></li>")}),e(".loveList").empty().html(b.join(""))}else e(".loveList").empty().html("<li class='nomatch'><i class='icon-github-alt'></i>你还木有收藏喜欢的歌</li>")}function m(){var a=e(".ul_list li").index(e(".ul_list li.liactive"));a+1>=e(".ul_list li").size()?(D.css({color:"#666",cursor:"not-allowed"}),D.addClass("disabled")):(D.css({color:"#fff",cursor:"pointer"}),D.removeClass("disabled")),0===a?(E.css({color:"#666",cursor:"not-allowed"}),E.addClass("disabled")):(E.css({color:"#fff",cursor:"pointer"}),E.removeClass("disabled"))}function n(){C.on("click",function(){e("#p_icon").hasClass("icon-play")?J.play():J.pause()}),D.on("click",function(){e(this).hasClass("disabled")||J.next()}),E.on("click",function(){e(this).hasClass("disabled")||J.prev()}),F.on("click",function(){e(this).hasClass("icon-indent-right")?(e(this).removeClass("icon-indent-right").addClass("icon-refresh"),I="refresh"):e(this).hasClass("icon-refresh")?(e(this).removeClass("icon-refresh").addClass("icon-random"),I="random"):e(this).hasClass("icon-random")&&(e(this).removeClass("icon-random").addClass("icon-indent-right"),I="order")})}function o(a){r(!1);var d=y[a||z];a&&(z=a);var f=e("<audio id='playerAudio' preload='auto'></audio>");f.append("<source src='"+d.url+"'></source>"),e("#audioContainer").empty().append(f),G=f.get(0),s(G),G.load(),p(),b.init(d.url,r,1),c.init(d,G)}function p(){var a=y[z].fileHead,b=y[z].imgUrl.replace(/\{size\}/g,a);e(".coverImg").attr("src",b),e(".songinfo .info dt").text(y[z].fileName),e(".songinfo .info dd").text(y[z].singerName)}function q(a){G&&(G.pause(),G.currentTime=0),B&&clearInterval(B),h(C,0,50),e(".pronum").text("00:00"),e("#p_icon").removeClass("icon-pause").addClass("icon-play"),a?(r(!0),b.suspend(null,1)):(r(!1),b.suspend(r)),c.stop()}function r(a,b){a?(e("#p_icon").removeClass().addClass("icon-play"),H&&"refresh"===I&&1!=b&&(J.play(),H=!1)):e("#p_icon").removeClass().addClass("icon-spinner icon-spin"),1==b&&J.play()}function s(a){a.addEventListener("canplay",function(){A=this.duration},!1),a.addEventListener("ended",t,!1)}function t(){switch(H=!0,I){case"order":q(1),D.trigger("click");break;case"refresh":q();break;case"random":q(1)}}function u(){if(G){var a=1e3*G.currentTime|0;a+=100;var b=a/A*.1;h(C,b,50),e(".pronum").text(v(a/1e3))}}function v(a){var b="00"+(a/60|0),c=a%60;return c="00"+(0|c),[b.substr(-2),c.substr(-2)].join(":")}function w(a,b){e.ajax({url:a,type:"GET",dataType:"jsonp",data:b,jsonp:"callback",jsonpCallback:b.callback,success:function(a){console.log(a)},error:function(a){console.log(a)}})}function x(){String.prototype.trim=function(){return this.replace(/^\s*|\s*$/g,"")},window.Kugou=K}var y=[{fileHead:100,singerName:"韩红",fileName:"韩红 - 天之大",url:"http://fs.open.kugou.com/fc8b84dd590665bda56d9bf862fdf072/5827b693/G072/M02/06/07/KJQEAFdUViWAPaBSAEflpT31pcw807.mp3",imgUrl:"http://singerimg.kugou.com/uploadpic/softhead/{size}/20160629/20160629120333920437.jpg",timeLength:294}],z=0,A=0,B=null,C=e("#playButn"),D=e("#nextButn"),E=e("#prevButn"),F=e("#typeButn"),G=null,H=!1,I="order",J={play:function(){B&&clearInterval(B),B=setInterval(u,500),G.play(),e("#p_icon").removeClass("icon-play").addClass("icon-pause"),b.resume(G),c.resume()},pause:function(){G.pause(),B&&clearInterval(B),e("#p_icon").removeClass("icon-pause").addClass("icon-play"),r(!1),b.suspend(r)},next:function(){e(".ul_list li.liactive").next().find("span").trigger("click")},prev:function(){e(".ul_list li.liactive").prev().find("span").trigger("click")}},K={doSearch:function(a,b,c,d){var e={cmd:300,keyword:encodeURIComponent(a),page:1,pageSize:20,outputtype:"jsonp",callback:c||"Kugou.searchBack"};w("http://mobilecdn.kugou.com/new/app/i/search.php",e)},bindEvent:function(){var a=this;e("#searchBtn").on("click",K.searchEvent),e(".ul_list").on("click","span",function(){var b=e(this).closest("li").data("hash");e(".ul_list li.liactive").removeClass("liactive"),e(this).closest("li").addClass("liactive"),m(),a.getSongInfo(b,i)}),e(".ul_list").on("click","i",function(){var a=e(this).closest("li"),b={hash:a.data("hash"),filename:a.data("filename")};e(this).css("color","#f00"),k(b)}),e(".listmenu li").on("click",function(){e(".listmenu li.active").removeClass("active"),e(this).addClass("active");var a=e(this).data("side");e(".listContainer").stop().animate({marginLeft:260*-a+"px"})}),m()},searchEvent:function(a){var b=e("#keyword").val().trim();return K.doSearch(b),!1},searchBack:function(a){if(a.status){for(var b=a.data,c=[],d=0,f=b.length;d<f;d++)c.push('<li data-extname="'+b[d].extname+'" data-bitrate="'+b[d].bitrate+'" data-time="'+b[d].timelength+'" data-filename="'+b[d].filename+'" data-hash="'+b[d].hash+'" ><span>'+b[d].filename+'</span><i class="icon-heart"></i></li>');c=c.join(""),e(".searchList").mCustomScrollbar("destroy"),e(".searchList").html(c),e(".searchList").mCustomScrollbar({axis:"y",theme:"dark-3"})}},getSongInfo:function(a,b){b=b||emptyFn,e.get("kproxy.php",{base:"/app/i/getSongInfo.php",query:encodeURIComponent("cmd=playInfo&hash="+a)},b,"json")}};g.exports={init:function(){x(),j(),K.bindEvent(),l()}}}),define("background",["exports","module"],function(a,b){var c=200,d=window.innerWidth,e=window.innerHeight,f=0,g=0,h=150,i=null,j=function(a){return a*Math.PI/180},k=function(){return Math.sin(Math.floor(360*Math.random())*Math.PI/180)},l={obj:{x:f,y:g,z:h},dest:{x:0,y:0,z:1},dist:{x:0,y:0,z:200},ang:{cplane:0,splane:0,ctheta:0,stheta:0},zoom:1,disp:{x:d/2,y:e/2,z:0},upd:function(){l.dist.x=l.dest.x-l.obj.x,l.dist.y=l.dest.y-l.obj.y,l.dist.z=l.dest.z-l.obj.z,l.ang.cplane=-l.dist.z/Math.sqrt(l.dist.x*l.dist.x+l.dist.z*l.dist.z),l.ang.splane=l.dist.x/Math.sqrt(l.dist.x*l.dist.x+l.dist.z*l.dist.z),l.ang.ctheta=Math.sqrt(l.dist.x*l.dist.x+l.dist.z*l.dist.z)/Math.sqrt(l.dist.x*l.dist.x+l.dist.y*l.dist.y+l.dist.z*l.dist.z),l.ang.stheta=-l.dist.y/Math.sqrt(l.dist.x*l.dist.x+l.dist.y*l.dist.y+l.dist.z*l.dist.z)}},m={parts:{sz:function(a,b){return{x:a.x*b.x,y:a.y*b.y,z:a.z*b.z}},rot:{x:function(a,b){return{x:a.x,y:a.y*Math.cos(j(b.x))-a.z*Math.sin(j(b.x)),z:a.y*Math.sin(j(b.x))+a.z*Math.cos(j(b.x))}},y:function(a,b){return{x:a.x*Math.cos(j(b.y))+a.z*Math.sin(j(b.y)),y:a.y,z:-a.x*Math.sin(j(b.y))+a.z*Math.cos(j(b.y))}},z:function(a,b){return{x:a.x*Math.cos(j(b.z))-a.y*Math.sin(j(b.z)),y:a.x*Math.sin(j(b.z))+a.y*Math.cos(j(b.z)),z:a.z}}},pos:function(a,b){return{x:a.x+b.x,y:a.y+b.y,z:a.z+b.z}}},pov:{plane:function(a){return{x:a.x*l.ang.cplane+a.z*l.ang.splane,y:a.y,z:a.x*-l.ang.splane+a.z*l.ang.cplane}},theta:function(a){return{x:a.x,y:a.y*l.ang.ctheta-a.z*l.ang.stheta,z:a.y*l.ang.stheta+a.z*l.ang.ctheta}},set:function(a){return{x:a.x-l.obj.x,y:a.y-l.obj.y,z:a.z-l.obj.z}}},persp:function(a){return{x:a.x*l.dist.z/a.z*l.zoom,y:a.y*l.dist.z/a.z*l.zoom,z:a.z*l.zoom,p:l.dist.z/a.z}},disp:function(a,b){return{x:a.x+b.x,y:-a.y+b.y,z:a.z+b.z,p:a.p}},steps:function(a,b,c,d,e){var f=m.parts.sz(a,b);return f=m.parts.rot.x(f,c),f=m.parts.rot.y(f,c),f=m.parts.rot.z(f,c),f=m.parts.pos(f,d),f=m.pov.plane(f),f=m.pov.theta(f),f=m.pov.set(f),f=m.persp(f),f=m.disp(f,e)}},n=function(a){this.transIn={},this.transOut={},this.transIn.vtx=a.vtx,this.transIn.sz=a.sz,this.transIn.rot=a.rot,this.transIn.pos=a.pos};n.prototype.vupd=function(){this.transOut=m.steps(this.transIn.vtx,this.transIn.sz,this.transIn.rot,this.transIn.pos,l.disp)};var o=function(a){this.vel=.04,this.lim=360,this.diff=200,this.initPos=100,this.toX=f,this.toY=g,this.canvas=a,this.go()};o.prototype.go=function(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.$=this.canvas.getContext("2d"),this.$.globalCompositeOperation="source-over",this.varr=[],this.dist=[],this.calc=[];for(var a=0,b=c;a<b;a++)this.add();this.rotObj={x:0,y:0,z:0},this.objSz={x:d/5,y:e/5,z:d/5}},o.prototype.add=function(){this.varr.push(new n({vtx:{x:k(),y:k(),z:k()},sz:{x:0,y:0,z:0},rot:{x:20,y:-20,z:0},pos:{x:this.diff*Math.sin(360*Math.random()*Math.PI/180),y:this.diff*Math.sin(360*Math.random()*Math.PI/180),z:this.diff*Math.sin(360*Math.random()*Math.PI/180)}})),this.calc.push({x:360*Math.random(),y:360*Math.random(),z:360*Math.random()})},o.prototype.upd=function(){l.obj.x+=.05*(this.toX-l.obj.x),l.obj.y+=.05*(this.toY-l.obj.y)},o.prototype.draw=function(){this.$.clearRect(0,0,this.canvas.width,this.canvas.height),l.upd(),this.rotObj.x+=.1,this.rotObj.y+=.1,this.rotObj.z+=.1;for(var a=0;a<this.varr.length;a++){for(var b in this.calc[a])this.calc[a].hasOwnProperty(b)&&(this.calc[a][b]+=this.vel,this.calc[a][b]>this.lim&&(this.calc[a][b]=0));if(this.varr[a].transIn.pos={x:this.diff*Math.cos(this.calc[a].x*Math.PI/180),y:this.diff*Math.sin(this.calc[a].y*Math.PI/180),z:this.diff*Math.sin(this.calc[a].z*Math.PI/180)},this.varr[a].transIn.rot=this.rotObj,this.varr[a].transIn.sz=this.objSz,this.varr[a].vupd(),!(this.varr[a].transOut.p<0)){var c=this.$.createRadialGradient(this.varr[a].transOut.x,this.varr[a].transOut.y,this.varr[a].transOut.p,this.varr[a].transOut.x,this.varr[a].transOut.y,2*this.varr[a].transOut.p);this.$.globalCompositeOperation="lighter",c.addColorStop(0,"hsla(255, 255%, 255%, 1)"),c.addColorStop(.5,"hsla("+(a+2)+",85%, 40%,1)"),c.addColorStop(1,"hsla("+a+",85%, 40%,.5)"),this.$.fillStyle=c,this.$.beginPath(),this.$.arc(this.varr[a].transOut.x,this.varr[a].transOut.y,2*this.varr[a].transOut.p,0,2*Math.PI,!1),this.$.fill(),this.$.closePath()}}},o.prototype.anim=function(){window.requestAnimationFrame=function(){return window.requestAnimationFrame||function(a,b){window.setTimeout(a,1e3/60)}}();var a=function(){this.upd(),this.draw(),window.requestAnimationFrame(a)}.bind(this);window.requestAnimationFrame(a)},o.prototype.run=function(){this.anim(),window.addEventListener("mousemove",function(a){this.toX=(a.clientX-this.canvas.width/2)*-.8,this.toY=.8*(a.clientY-this.canvas.height/2)}.bind(this)),window.addEventListener("touchmove",function(a){a.preventDefault(),this.toX=(a.touches[0].clientX-this.canvas.width/2)*-.8,this.toY=.8*(a.touches[0].clientY-this.canvas.height/2)}.bind(this)),window.addEventListener("mousedown",function(a){for(var b=0;b<100;b++)this.add()}.bind(this)),window.addEventListener("touchstart",function(a){a.preventDefault();for(var b=0;b<100;b++)this.add()}.bind(this))},b.exports={init:function(){i=document.getElementById("bgcanv");var a=new o(i);a.run(),window.addEventListener("resize",function(){i.width=d=window.innerWidth,i.height=e=window.innerHeight},!1)}}}),require.config({paths:{jquery:"../../dest/js/lib/jquery-1.9.1.min",background:"./app/background",player:"./app/player",visualizer:"./app/visualizer",lrcmanager:"./app/LrcManager","jquery.mCustomScrollbar":"../../dest/js/lib/mCustomScrollbar.concat.min"},shim:{"jquery.mCustomScrollbar":["jquery"]}}),require(["require","jquery","player","background"],function(a,b,c,d){c.init()}),define("app/main",function(){});
//# sourceMappingURL=../../sourcemap.map